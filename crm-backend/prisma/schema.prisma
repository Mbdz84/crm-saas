generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// MODEL company
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//

model Company {
  id        String   @id @default(cuid())
  name      String
  domain    String?
  phone     String?
  address   String?
  logoUrl   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // JSON settings for technician SMS template
  smsSettings Json? // â† NEW

  timezone String? @default("America/Chicago")

  // Relations
  users        User[]
  jobs         Job[]
  jobTypes     JobType[]
  leadSources  LeadSource[]
  callSessions JobCallSession[] @relation("CompanyCallSessions")
}

//
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// user model
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  phone     String?
  active    Boolean  @default(true)
  role      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  technicianJobs    Job[]        @relation("TechnicianJobs")
  jobClosingsClosed JobClosing[] @relation("JobClosingClosedBy")

  callSessions JobCallSession[] @relation("UserCallSessions")
  maskedCalls  Boolean          @default(false)
  logs         JobLog[]

  // ğŸ”½ NEW TECH SETTINGS ğŸ”½

  // Notifications / behaviour
  receiveSms     Boolean @default(true)
  payrollEnabled Boolean @default(false)
  canSeeClosing  Boolean @default(true) // can see closing panel
  canViewAllJobs Boolean @default(true) // false â†’ only jobs assigned to this tech

  // Financial defaults
  defaultTechPercent         Decimal? @db.Decimal(5, 2)
  defaultPartsResponsibility String? // "tech" | "company" | "split" etc.
  defaultTechPaysExtraFee    Boolean  @default(false)
  defaultCcFeePercent        Decimal? @db.Decimal(5, 2)
  defaultCheckFeePercent     Decimal? @db.Decimal(5, 2)

  // Adjustment permissions
  canAdjustPercentages Boolean @default(false)
  canAdjustParts       Boolean @default(false)
  canAdjustFees        Boolean @default(false)

  timezone String? @default("America/Chicago")

  // Availability (JSON like { mon:{enabled:true,from:"09:00",to:"17:00"}, ... })
  availability Json?
}

//
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// JOB TYPES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//
model JobType {
  id       String  @id @default(cuid())
  name     String
  active   Boolean @default(true)
  timezone String?

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  jobs Job[]
}

//
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// LEAD SOURCES
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//
model LeadSource {
  id   String @id @default(cuid())
  name String

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // API AUTH (Direct JSON ingestion)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  apiKeyHash      String?  @unique
  apiKeyLast4     String?
  apiKeyCreatedAt DateTime?

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Profile / behavior
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  color  String  @default("#6b7280") // tag color for UI
  active Boolean @default(true) // can be selected for new jobs
  locked Boolean @default(false) // protect from edits/deletes

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Financial defaults
  // (all optional â€“ if null, do nothing)
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  defaultLeadPercent      Decimal? @db.Decimal(5, 2) // e.g. 35.00
  defaultAdditionalFee    Decimal? @db.Decimal(10, 2) // flat fee $
  defaultCcFeePercent     Decimal? @db.Decimal(5, 2) // CC fee %
  defaultCheckFeePercent  Decimal? @db.Decimal(5, 2) // Check fee %
  autoApplyFinancialRules Boolean  @default(false) // auto fill in closing panel

  jobs Job[]
}

//
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// JOB MODEL
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//
model Job {
  id              String  @id @default(cuid())
  shortId         String  @unique
  title           String
  description     String?
  customerName    String?
  customerPhone   String?
  customerPhone2  String?
  customerAddress String?

  jobTypeId    String?
  technicianId String?
  sourceId     String?
  statusId     String?
  status       String    @default("Accepted")
  scheduledAt  DateTime?
  companyId    String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  jobType    JobType?    @relation(fields: [jobTypeId], references: [id])
  technician User?       @relation("TechnicianJobs", fields: [technicianId], references: [id])
  source     LeadSource? @relation(fields: [sourceId], references: [id])
  company    Company     @relation(fields: [companyId], references: [id])

  jobStatus       JobStatus? @relation("JobStatusRelation", fields: [statusId], references: [id])
  closedAt        DateTime?
  isClosingLocked Boolean    @default(false)

  closing      JobClosing?
  logs         JobLog[]
  callSessions JobCallSession[]
  records      JobRecord[]

  timezone  String?
  reminders JobReminder[]

  canceledReason String? // text note when job is canceled
  canceledAt     DateTime? // when it was canceled
}

//
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// JOB closing
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//
model JobClosing {
  id String @id @default(cuid())

  // link to job
  jobId String @unique
  job   Job    @relation(fields: [jobId], references: [id])

  // who closed it
  closedAt       DateTime @default(now())
  closedByUserId String?
  closedByUser   User?    @relation("JobClosingClosedBy", fields: [closedByUserId], references: [id])

  // invoice number (optional, for your report)
  invoiceNumber String?

  // payments snapshot (your PaymentRow[])
  payments Json

  // core money fields
  totalAmount     Decimal  @db.Decimal(10, 2)
  totalCcFee      Decimal  @db.Decimal(10, 2)
  ccFeePercentAvg Decimal? @db.Decimal(5, 2)

  techParts    Decimal @db.Decimal(10, 2)
  leadParts    Decimal @db.Decimal(10, 2)
  companyParts Decimal @db.Decimal(10, 2)
  totalParts   Decimal @db.Decimal(10, 2)

  adjustedTotal Decimal @db.Decimal(10, 2)

  // percentages
  techPercent    Decimal @db.Decimal(5, 2)
  leadPercent    Decimal @db.Decimal(5, 2)
  companyPercent Decimal @db.Decimal(5, 2)

  // v1.1 + v1.2 + v1.3 toggles
  excludeTechFromParts  Boolean @default(false)
  techPaysAdditionalFee Boolean @default(false)
  leadAdditionalFee     Decimal @db.Decimal(10, 2)
  leadOwnedByCompany    Boolean @default(false)

  // profits (display + base)
  techProfit           Decimal @db.Decimal(10, 2)
  leadProfit           Decimal @db.Decimal(10, 2)
  companyProfitBase    Decimal @db.Decimal(10, 2)
  companyProfitDisplay Decimal @db.Decimal(10, 2)

  // balances
  techBalance    Decimal @db.Decimal(10, 2)
  leadBalance    Decimal @db.Decimal(10, 2)
  companyBalance Decimal @db.Decimal(10, 2)

  // Financial check
  sumCheck Decimal @db.Decimal(10, 4)

  // new payment totals
  cashTotal   Decimal  @default(0) @db.Decimal(10, 2)
  creditTotal Decimal  @default(0) @db.Decimal(10, 2)
  checkTotal  Decimal  @default(0) @db.Decimal(10, 2)
  zelleTotal  Decimal  @default(0) @db.Decimal(10, 2)
  createdAt   DateTime @default(now())
}

//
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// JobLog - log teb inside job page
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//
model JobLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  type      String
  text      String

  // NEW â€” who created the log
  userId String?
  user   User?   @relation(fields: [userId], references: [id])

  jobId String
  job   Job    @relation(fields: [jobId], references: [id])
}

//
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// JOB STATUS LIST
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//
model JobStatus {
  id     String  @id @default(cuid())
  name   String
  order  Int     @default(0)
  active Boolean @default(true)

  color  String  @default("#6b7280") // NEW
  locked Boolean @default(false) // NEW

  jobs Job[] @relation("JobStatusRelation")
}

//
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TWILIO CALL RECORDING TO TECHS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//
model JobCallSession {
  id           String @id @default(cuid())
  jobId        String
  job          Job    @relation(fields: [jobId], references: [id])
  technicianId String

  customerPhone String
  extension     String
  technician    User    @relation("UserCallSessions", fields: [technicianId], references: [id])
  company       Company @relation("CompanyCallSessions", fields: [companyId], references: [id])

  companyId String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([jobId])
  @@index([technicianId])
  @@index([customerPhone])
  @@index([companyId, extension])
}

//
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// TWILIO JOB CALL RECORDINGS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//
model JobRecord {
  id            String  @id @default(cuid())
  jobId         String
  callSid       String
  recordingSid  String
  from          String?
  to            String?
  url           String
  parentCallSid String?

  // NEW FIELDS NEEDED FOR UI + TWILIO
  duration   Int? // Recording duration
  status     String? // completed | busy | failed | no-answer | ringing | queued
  transcript String? // optional text transcript

  createdAt DateTime @default(now())

  job Job @relation(fields: [jobId], references: [id])
}

//
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// JOB REMINDERS (Appointment SMS)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//
model JobReminder {
  id               String   @id @default(cuid())

  jobId            String   @map("job_id")
  job              Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)

  minutesBefore    Int      @map("minutes_before")
  scheduledFor     DateTime @map("scheduled_for")

  sendToTechnician Boolean  @default(true) @map("send_to_technician")

  sentAt           DateTime? @map("sent_at")

  canceled         Boolean  @default(false)
  canceledAt       DateTime? @map("canceledAt")

  createdAt        DateTime @default(now()) @map("created_at")

  @@index([jobId])
  @@index([scheduledFor])
  @@map("JobReminder")
}