generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Company {
  id                    String           @id @default(cuid())
  name                  String
  domain                String?
  phone                 String?
  address               String?
  logoUrl               String?
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  smsSettings           Json?
  notifyTechOnJobCreate Boolean          @default(false)
  timezone              String           @default("America/Chicago")
  jobs                  Job[]
  callSessions          JobCallSession[] @relation("CompanyCallSessions")
  jobTypes              JobType[]
  leadSources           LeadSource[]
  users                 User[]
}

model User {
  id                         String           @id @default(cuid())
  email                      String           @unique
  password                   String
  name                       String
  phone                      String?
  active                     Boolean          @default(true)
  role                       String
  createdAt                  DateTime         @default(now())
  updatedAt                  DateTime         @updatedAt
  companyId                  String
  maskedTwilioNumberSid      String? // PNxxxxxxxx
  maskedTwilioPhoneNumber    String?
  maskedCalls                Boolean          @default(false)
  receiveSms                 Boolean?         @default(true)
  payrollEnabled             Boolean          @default(false)
  canSeeClosing              Boolean          @default(true)
  canViewAllJobs             Boolean          @default(true)
  defaultTechPercent         Decimal?         @db.Decimal(5, 2)
  defaultPartsResponsibility String?
  defaultTechPaysExtraFee    Boolean          @default(false)
  defaultCcFeePercent        Decimal?         @db.Decimal(5, 2)
  defaultCheckFeePercent     Decimal?         @db.Decimal(5, 2)
  canAdjustPercentages       Boolean          @default(false)
  canAdjustParts             Boolean          @default(false)
  canAdjustFees              Boolean          @default(false)
  availability               Json?            @db.Json
  timezone                   String?          @default("America/Chicago")
  technicianJobs             Job[]            @relation("TechnicianJobs")
  callSessions               JobCallSession[] @relation("UserCallSessions")
  jobClosingsClosed          JobClosing[]     @relation("JobClosingClosedBy")
  logs                       JobLog[]
  company                    Company          @relation(fields: [companyId], references: [id])
}

model JobType {
  id        String  @id @default(cuid())
  name      String
  active    Boolean @default(true)
  companyId String
  timezone  String  @default("America/Chicago")
  jobs      Job[]
  company   Company @relation(fields: [companyId], references: [id])

  @@unique([name, companyId])
}

model LeadSource {
  id                      String    @id @default(cuid())
  name                    String
  companyId               String
  defaultLeadPercent      Decimal?  @db.Decimal(5, 2)
  defaultAdditionalFee    Decimal?  @db.Decimal(10, 2)
  defaultCcFeePercent     Decimal?  @db.Decimal(5, 2)
  defaultCheckFeePercent  Decimal?  @db.Decimal(5, 2)
  color                   String    @default("#6b7280")
  active                  Boolean   @default(true)
  locked                  Boolean   @default(false)
  autoApplyFinancialRules Boolean   @default(false)
  apiKeyHash              String?   @unique
  apiKeyLast4             String?
  apiKeyCreatedAt         DateTime? @db.Timestamptz(6)
  incomingSmsNumbers      String[]
  jobs                    Job[]
  company                 Company   @relation(fields: [companyId], references: [id])
}

model Job {
  id              String           @id @default(cuid())
  shortId         String           @unique
  title           String
  description     String?
  customerName    String?
  customerPhone   String?
  customerAddress String?
  jobTypeId       String?
  technicianId    String?
  sourceId        String?
  statusId        String?
  status          String           @default("Accepted")
  scheduledAt     DateTime?
  companyId       String
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  closedAt        DateTime?
  isClosingLocked Boolean          @default(false)
  customerPhone2  String?
  canceledAt      DateTime?
  canceledReason  String?
  timezone        String           @default("America/Chicago")
  company         Company          @relation(fields: [companyId], references: [id])
  jobType         JobType?         @relation(fields: [jobTypeId], references: [id])
  source          LeadSource?      @relation(fields: [sourceId], references: [id])
  jobStatus       JobStatus?       @relation("JobStatusRelation", fields: [statusId], references: [id])
  technician      User?            @relation("TechnicianJobs", fields: [technicianId], references: [id])
  callSessions    JobCallSession[]
  closing         JobClosing?
  logs            JobLog[]
  records         JobRecord[]
  reminders       JobReminder[]
}

model JobClosing {
  id                    String   @id @default(cuid())
  jobId                 String   @unique
  closedAt              DateTime @default(now())
  closedByUserId        String?
  invoiceNumber         String?
  payments              Json
  totalAmount           Decimal  @db.Decimal(10, 2)
  totalCcFee            Decimal  @db.Decimal(10, 2)
  ccFeePercentAvg       Decimal? @db.Decimal(5, 2)
  techParts             Decimal  @db.Decimal(10, 2)
  leadParts             Decimal  @db.Decimal(10, 2)
  companyParts          Decimal  @db.Decimal(10, 2)
  totalParts            Decimal  @db.Decimal(10, 2)
  adjustedTotal         Decimal  @db.Decimal(10, 2)
  techPercent           Decimal  @db.Decimal(5, 2)
  leadPercent           Decimal  @db.Decimal(5, 2)
  companyPercent        Decimal  @db.Decimal(5, 2)
  excludeTechFromParts  Boolean  @default(false)
  techPaysAdditionalFee Boolean  @default(false)
  leadAdditionalFee     Decimal  @db.Decimal(10, 2)
  leadOwnedByCompany    Boolean  @default(false)
  techProfit            Decimal  @db.Decimal(10, 2)
  leadProfit            Decimal  @db.Decimal(10, 2)
  companyProfitBase     Decimal  @db.Decimal(10, 2)
  companyProfitDisplay  Decimal  @db.Decimal(10, 2)
  techBalance           Decimal  @db.Decimal(10, 2)
  leadBalance           Decimal  @db.Decimal(10, 2)
  companyBalance        Decimal  @db.Decimal(10, 2)
  sumCheck              Decimal  @db.Decimal(10, 4)
  cashTotal             Decimal  @default(0) @db.Decimal(10, 2)
  creditTotal           Decimal  @default(0) @db.Decimal(10, 2)
  checkTotal            Decimal  @default(0) @db.Decimal(10, 2)
  zelleTotal            Decimal  @default(0) @db.Decimal(10, 2)
  createdAt             DateTime @default(now())
  closedByUser          User?    @relation("JobClosingClosedBy", fields: [closedByUserId], references: [id])
  job                   Job      @relation(fields: [jobId], references: [id])
}

model JobLog {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  type      String
  text      String
  userId    String?
  jobId     String
  job       Job      @relation(fields: [jobId], references: [id])
  user      User?    @relation(fields: [userId], references: [id])
}

model JobStatus {
  id     String  @id @default(cuid())
  name   String
  order  Int     @default(0)
  active Boolean @default(true)
  color  String  @default("#6b7280")
  locked Boolean @default(false)
  jobs   Job[]   @relation("JobStatusRelation")
}

model JobCallSession {
  id              String   @id @default(cuid())

  jobId           String
  companyId       String
  technicianId    String?          // ← make optional

  customerPhone   String
  clientPhoneType String?
  extension       String

  lastCallerPhone String?           // ← ADD
  lastInboundCallSid   String?
  lastOutboundCallSid String?
  active          Boolean @default(true) // ← ADD

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company    Company @relation("CompanyCallSessions", fields: [companyId], references: [id])
  job        Job     @relation(fields: [jobId], references: [id])
  technician User?   @relation("UserCallSessions", fields: [technicianId], references: [id])

  @@index([jobId])
  @@index([customerPhone])
  @@index([companyId, extension])
  @@index([technicianId])
}

model JobRecord {
  id            String   @id @default(cuid())
  jobId         String
  callSid       String
  recordingSid  String?
  from          String?
  to            String?
  url           String?
  parentCallSid String?
  duration      Int?
  status        String?
  transcript    String?
  createdAt     DateTime @default(now())
  job           Job      @relation(fields: [jobId], references: [id])
}

model JobReminder {
  id               String    @id @default(dbgenerated("gen_random_uuid()"))
  jobId            String    @map("job_id")
  minutesBefore    Int       @map("minutes_before")
  sendToTechnician Boolean?  @default(true) @map("send_to_technician")
  scheduledFor     DateTime  @map("scheduled_for") @db.Timestamptz(6)
  sentAt           DateTime? @map("sent_at") @db.Timestamptz(6)
  canceled         Boolean?  @default(false)
  createdAt        DateTime? @default(now()) @map("created_at") @db.Timestamptz(6)
  canceledAt       DateTime? @map("canceledAt")
  job              Job       @relation(fields: [jobId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([jobId], map: "job_reminder_job_id_idx")
  @@index([scheduledFor], map: "job_reminder_scheduled_for_idx")
  @@map("JobReminder")
}